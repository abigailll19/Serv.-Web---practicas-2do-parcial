# ðŸ“Š Diagramas del Sistema

## Arquitectura General

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENTE HTTP                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ POST /usuarios
                         â”‚ POST /resenas
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MS-GATEWAY :3000                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  - Genera UUID para cada mensaje                          â”‚ â”‚
â”‚  â”‚  - Emite eventos a RabbitMQ                               â”‚ â”‚
â”‚  â”‚  - No tiene base de datos                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚                   â”‚
       usuario.createâ”‚                   â”‚resena.request
                     â”‚                   â”‚
                     â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        RABBITMQ :5672                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  usuario_queue      â”‚       â”‚  resena_queue       â”‚         â”‚
â”‚  â”‚  (durable)          â”‚       â”‚  (durable)          â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â”‚                                  â”‚                    â”‚
â”‚         â”‚ resena.created                   â”‚                    â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                  â”‚
          â–¼                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MS-USUARIO :3003      â”‚    â”‚   MS-RESENA :3004       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ UsuarioConsumer   â”‚  â”‚    â”‚  â”‚ ResenaController  â”‚  â”‚
â”‚  â”‚ UsuarioService    â”‚  â”‚    â”‚  â”‚ ResenaService     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â”‚ IdempotencyGuard  â”‚  â”‚
â”‚            â”‚             â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â–¼             â”‚    â”‚            â–¼             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  usuario_db       â”‚  â”‚    â”‚  â”‚  resena_db        â”‚  â”‚
â”‚  â”‚  PostgreSQL       â”‚  â”‚    â”‚  â”‚  PostgreSQL       â”‚  â”‚
â”‚  â”‚  :5435            â”‚  â”‚    â”‚  â”‚  :5436            â”‚  â”‚
â”‚  â”‚                   â”‚  â”‚    â”‚  â”‚                   â”‚  â”‚
â”‚  â”‚  - Usuario        â”‚  â”‚    â”‚  â”‚  - Resena         â”‚  â”‚
â”‚  â”‚                   â”‚  â”‚    â”‚  â”‚  - Idempotency    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Flujo de CreaciÃ³n de Usuario

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    HTTP POST    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   usuario.create   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ Gateway  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ RabbitMQ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   /usuarios     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    + message_id     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                                                  â”‚
                                                                  â”‚
                                                                  â–¼
                                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                            â”‚ Usuario  â”‚
                                                            â”‚ Consumer â”‚
                                                            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                                                 â”‚
                                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                        â”‚ Â¿Correo existe? â”‚
                                                        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                                                             â”‚       â”‚
                                                         SÃ  â”‚       â”‚ NO
                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                            â”‚                                       â”‚
                                            â–¼                                       â–¼
                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                   â”‚ Retornar       â”‚                    â”‚ Crear nuevo  â”‚
                                   â”‚ existente      â”‚                    â”‚ usuario en   â”‚
                                   â”‚ (idempotencia) â”‚                    â”‚ PostgreSQL   â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚                                       â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â”‚
                                                        â–¼
                                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                  â”‚ ACK msg  â”‚
                                                  â”‚ RabbitMQ â”‚
                                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Flujo de CreaciÃ³n de ReseÃ±a con Idempotencia

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   HTTP POST   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  resena.request  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ Gateway  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ RabbitMQ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   /resenas    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   + message_id   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                                              â”‚
                                                              â”‚
                                                              â–¼
                                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                        â”‚ Resena   â”‚
                                                        â”‚ Consumer â”‚
                                                        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                                             â”‚
                                                             â–¼
                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚ IdempotencyGuardâ”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                            â”‚
                                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                               â”‚ Â¿message_id procesado?  â”‚
                                               â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                                    â”‚              â”‚
                                                SÃ  â”‚              â”‚ NO
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚                                             â”‚
                                    â–¼                                             â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ Ignorar mensaje  â”‚                        â”‚ Registrar en    â”‚
                          â”‚ duplicado        â”‚                        â”‚ tabla           â”‚
                          â”‚ [IDEMP] log      â”‚                        â”‚ idempotency     â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚                                          â”‚
                                    â”‚                                          â–¼
                                    â”‚                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚                                â”‚ Crear reseÃ±a    â”‚
                                    â”‚                                â”‚ en PostgreSQL   â”‚
                                    â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚                                         â”‚
                                    â”‚                                         â–¼
                                    â”‚                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚                               â”‚ Emitir evento   â”‚
                                    â”‚                               â”‚ resena.created  â”‚
                                    â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚                                        â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â–¼
                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                           â”‚ ACK msg  â”‚
                                           â”‚ RabbitMQ â”‚
                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Modelo de Datos

### Base de Datos: usuario_db

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Usuario                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id              UUID (PK)           â”‚
â”‚ nombre          VARCHAR(255)        â”‚
â”‚ correo          VARCHAR(255) UNIQUE â”‚
â”‚ contrasena      VARCHAR(255)        â”‚
â”‚ tipo            VARCHAR(50)         â”‚
â”‚ idiomaPreferido VARCHAR(10)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Base de Datos: resena_db

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Resena                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id              UUID (PK)           â”‚
â”‚ autor           VARCHAR(200)        â”‚
â”‚ destino         VARCHAR(300)        â”‚
â”‚ mensaje         TEXT                â”‚
â”‚ calificacion    INTEGER             â”‚
â”‚ fecha           TIMESTAMPTZ         â”‚
â”‚ usuario_id      UUID (FK virtual)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Idempotency                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ message_id      UUID (PK)           â”‚
â”‚ consumer        VARCHAR(255)        â”‚
â”‚ processed_at    TIMESTAMPTZ         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Nota:** No hay foreign key fÃ­sica entre usuario_id y Usuario porque estÃ¡n en bases de datos diferentes. La relaciÃ³n es lÃ³gica a travÃ©s de eventos.

## ComunicaciÃ³n entre Microservicios

```
   ms-gateway          RabbitMQ           ms-usuario           ms-resena
       â”‚                  â”‚                    â”‚                   â”‚
       â”‚â”€â”€usuario.createâ”€>â”‚                    â”‚                   â”‚
       â”‚                  â”‚â”€â”€â”€â”€eventoâ”€â”€â”€â”€â”€â”€â”€â”€> â”‚                   â”‚
       â”‚                  â”‚                    â”‚â”€â”€procesar         â”‚
       â”‚                  â”‚                    â”‚   usuario         â”‚
       â”‚                  â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”‚
       â”‚                  â”‚                    â”‚                   â”‚
       â”‚â”€resena.requestâ”€â”€>â”‚                    â”‚                   â”‚
       â”‚                  â”‚â”€â”€â”€â”€eventoâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                  â”‚                    â”‚                   â”‚â”€â”€procesar
       â”‚                  â”‚                    â”‚                   â”‚   reseÃ±a
       â”‚                  â”‚                    â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€
       â”‚                  â”‚                    â”‚                   â”‚
       â”‚                  â”‚                    â”‚                   â”‚â”€resena.createdâ”€>â”‚
       â”‚                  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
       â”‚                  â”‚â”€â”€â”€â”€eventoâ”€â”€â”€â”€â”€â”€â”€â”€> â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”‚
       â”‚                  â”‚                    â”‚â”€â”€notificar                          â”‚
       â”‚                  â”‚                    â”‚   reseÃ±a                            â”‚
       â”‚                  â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€                           â”‚
```

## PatrÃ³n de Idempotencia

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Llegada de Mensaje                             â”‚
â”‚                    message_id = 123                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  IdempotencyGuard.run()     â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ INSERT INTO idempotency             â”‚
                â”‚ VALUES (message_id, consumer, now())â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ Â¿INSERT exitoso?          â”‚
                 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚           â”‚
                    SÃ  â”‚           â”‚ NO (duplicate key)
                        â”‚           â”‚
                        â–¼           â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Continuar con    â”‚   â”‚ Mensaje ya       â”‚
         â”‚ procesamiento    â”‚   â”‚ procesado antes  â”‚
         â”‚ del mensaje      â”‚   â”‚ RETURN           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Crear ReseÃ±a     â”‚
         â”‚ en BD            â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Emitir evento    â”‚
         â”‚ resena.created   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ ACK a RabbitMQ   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Escenario de Fallo y RecuperaciÃ³n

```
Tiempo   Gateway         RabbitMQ        ms-resena         PostgreSQL
  â”‚                         â”‚                â”‚                  â”‚
  â”‚â”€resena.requestâ”€â”€â”€â”€â”€â”€â”€â”€> â”‚                â”‚                  â”‚
  â”‚  (msg_id: ABC)          â”‚                â”‚                  â”‚
  â”‚                         â”‚                â”‚                  â”‚
  â”‚                         â”‚â”€â”€deliverâ”€â”€â”€â”€â”€> â”‚                  â”‚
  â”‚                         â”‚   (msg: ABC)   â”‚                  â”‚
  â”‚                         â”‚                â”‚                  â”‚
  â”‚                         â”‚                â”‚â”€â”€INSERT msg_idâ”€> â”‚
  â”‚                         â”‚                â”‚    ABC           â”‚
  â”‚                         â”‚                â”‚<â”€â”€OKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                         â”‚                â”‚                  â”‚
  â”‚                         â”‚                â”‚â”€â”€INSERT resenaâ”€> â”‚
  â”‚                         â”‚                â”‚                  â”‚
  â”‚                         â”‚                â”‚                  â”‚
  â”‚                         â”‚                â”‚  ðŸ’¥ CRASH        â”‚
  â”‚                         â”‚                â”‚  (antes de ACK)  â”‚
  â”‚                         â”‚                â”‚                  â”‚
  â”‚                         â”‚                â”‚                  â”‚
  â”‚                         â”‚                â”‚  ðŸ”„ REINICIO     â”‚
  â”‚                         â”‚                â”‚                  â”‚
  â”‚                         â”‚â”€â”€redeliverâ”€â”€â”€> â”‚                  â”‚
  â”‚                         â”‚   (msg: ABC)   â”‚  (mismo mensaje) â”‚
  â”‚                         â”‚                â”‚                  â”‚
  â”‚                         â”‚                â”‚â”€â”€INSERT msg_idâ”€> â”‚
  â”‚                         â”‚                â”‚    ABC           â”‚
  â”‚                         â”‚                â”‚<â”€ERRORâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                         â”‚                â”‚  (duplicate)     â”‚
  â”‚                         â”‚                â”‚                  â”‚
  â”‚                         â”‚                â”‚  âš ï¸ DETECTAR     â”‚
  â”‚                         â”‚                â”‚  DUPLICADO       â”‚
  â”‚                         â”‚                â”‚  NO PROCESAR     â”‚
  â”‚                         â”‚                â”‚                  â”‚
  â”‚                         â”‚<â”€â”€â”€ACKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚
  â”‚                         â”‚                â”‚                  â”‚
  â”‚                         â”‚  âœ… MENSAJE    â”‚                  â”‚
  â”‚                         â”‚  ELIMINADO     â”‚                  â”‚
  â”‚                         â”‚  DE COLA       â”‚                  â”‚
```

## ComparaciÃ³n: Con vs Sin Idempotencia

### Sin Idempotencia (ProblemÃ¡tico)

```
Cliente envÃ­a: "Crear reseÃ±a A"
   â†“
ms-resena procesa âœ…
ms-resena CRASH antes de ACK ðŸ’¥
   â†“
RabbitMQ reenvÃ­a: "Crear reseÃ±a A"
   â†“
ms-resena procesa âœ… (DUPLICADO!)
   â†“
Resultado: 2 reseÃ±as idÃ©nticas ðŸ˜ž
```

### Con Idempotencia (Correcto)

```
Cliente envÃ­a: "Crear reseÃ±a A" (msg_id: 123)
   â†“
ms-resena registra msg_id 123 en tabla
ms-resena procesa âœ…
ms-resena CRASH antes de ACK ðŸ’¥
   â†“
RabbitMQ reenvÃ­a: "Crear reseÃ±a A" (msg_id: 123)
   â†“
ms-resena verifica msg_id 123 â†’ YA EXISTE
ms-resena ignora mensaje
ms-resena envÃ­a ACK
   â†“
Resultado: 1 reseÃ±a âœ…
```

---

## Leyenda de SÃ­mbolos

- ðŸ“¥ Mensaje recibido
- âœ… OperaciÃ³n exitosa
- âš ï¸ Advertencia / Idempotencia aplicada
- âŒ Error
- ðŸ’¥ Crash / Fallo
- ðŸ”„ Reinicio / RecuperaciÃ³n
- ðŸš€ Servicio iniciado
- ðŸ‘‚ Escuchando eventos
